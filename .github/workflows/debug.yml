name: Debug Machine with Warp and Mihomo

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ========== åŸºç¡€é…ç½® ==========
      - name: Checkout repository
        uses: actions/checkout@v3

      # ========== å®‰è£…ä¾èµ– ==========
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            jq \
            wireguard \
            resolvconf \
            gzip

      # ========== å®‰è£… wgcf ==========
      - name: Install wgcf
        run: |
          curl -fsSL https://github.com/ViRb3/wgcf/releases/download/v2.2.18/wgcf_2.2.18_linux_amd64 -o wgcf
          chmod +x wgcf
          sudo mv wgcf /usr/local/bin/wgcf

      # ========== æ³¨å†Œ Warp å¹¶ç”Ÿæˆ WireGuard é…ç½®æ–‡ä»¶ ==========
      - name: Register Warp and generate WireGuard config
        run: |
          wgcf register --accept-tos --config wgcf-account.toml &
          sleep 10
          wgcf generate --config wgcf-account.toml --profile wgcf-profile.conf &
          sleep 10
          
          # ä¿®æ”¹é…ç½®æ–‡ä»¶ä»¥ç¡®ä¿æ‰€æœ‰æµé‡éƒ½èµ° WireGuard
          sed -i 's/AllowedIPs = 0.0.0.0\/0/AllowedIPs = 0.0.0.0\/1, 128.0.0.0\/1/g' wgcf-profile.conf
          sed -i 's/AllowedIPs = ::\/0/AllowedIPs = ::\/1, 8000::\/1/g' wgcf-profile.conf
          
          # å°†é…ç½®æ–‡ä»¶ç§»åŠ¨åˆ° WireGuard çš„é…ç½®ç›®å½•
          sudo cp wgcf-profile.conf /etc/wireguard/wg0.conf &
          sleep 10
          
          # å¯åŠ¨ WireGuard æ¥å£
          sudo wg-quick up wg0 &
          sleep 5
          
          # éªŒè¯ WireGuard è¿æ¥
          sudo wg show &
          sleep 5
          ip route show &
          sleep 5
          curl --interface wg0 -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" https://api.ip.sb/geoip &

      # ========== é…ç½® Mihomo æœ¬åœ°ä»£ç† ==========
      - name: Setup Mihomo
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          mkdir -p .mihomo
          cd .mihomo
          echo "ä¸‹è½½ Mihomo æ–‡ä»¶..."
          
          # ä½¿ç”¨ WireGuard æ¥å£ä¸‹è½½
          curl --interface wg0 -L -o mihomo-linux-amd64-v1.18.0.gz https://github.com/MetaCubeX/mihomo/releases/download/v1.18.0/mihomo-linux-amd64-v1.18.0.gz &
          sleep 10
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f mihomo-linux-amd64-v1.18.0.gz ]; then
            echo "æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          
          echo "è§£å‹æ–‡ä»¶..."
          gzip -d mihomo-linux-amd64-v1.18.0.gz &
          sleep 5
          
          # æ£€æŸ¥è§£å‹åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f mihomo-linux-amd64-v1.18.0 ]; then
            echo "æ–‡ä»¶è§£å‹å¤±è´¥ï¼"
            exit 1
          fi
          
          echo "é‡å‘½åæ–‡ä»¶..."
          mv mihomo-linux-amd64-v1.18.0 mihomo
          echo "è®¾ç½®å¯æ‰§è¡Œæƒé™..."
          chmod +x mihomo
          echo "Mihomo å®‰è£…å®Œæˆï¼"

      - name: Write YAML config file
        run: |
          cd .mihomo
          curl --interface wg0 -L -o config.yaml "${{ secrets.CONFIG_URL }}" &
          sleep 5

      - name: Download Web UI (Yacd)
        run: |
          curl --interface wg0 -L -o yacd.tar.xz https://github.com/haishanh/yacd/releases/download/v0.3.8/yacd.tar.xz &
          sleep 10
          tar -xJvf yacd.tar.xz &
          sleep 5
          mv public yacd
          mkdir -p .mihomo/ui
          mv yacd/* .mihomo/ui/

      - name: Start mihomo with Web UI
        run: |
          cd .mihomo
          echo "external-ui: ui" >> config.yaml
          
          # è®¾ç½®è·¯ç”±è§„åˆ™ï¼Œç¡®ä¿ Mihomo çš„å‡ºå£æµé‡é€šè¿‡ WireGuard
          sudo ip route add default dev wg0 table 200
          sudo ip rule add fwmark 0xca6c lookup 200
          
          # å¯åŠ¨ Mihomo
          ./mihomo -d . -f config.yaml &
          sleep 15

      # ========== é…ç½®æœ¬åœ°ä»£ç†ç¯å¢ƒå˜é‡ ==========
      - name: Configure proxy env
        run: |
          echo 'function proxy_on() {
            export http_proxy=http://127.0.0.1:7890
            export https_proxy=http://127.0.0.1:7890
            export all_proxy=socks5://127.0.0.1:7890
            echo -e "ç»ˆç«¯ä»£ç†å·²å¼€å¯"
          }
          function proxy_off(){
            unset http_proxy https_proxy all_proxy
            echo -e "ç»ˆç«¯ä»£ç†å·²å…³é—­"
          }' > ~/.bash_profile
          source ~/.bash_profile
          proxy_on

      # ========== åŠ¨æ€é€‰æ‹©æœ€å¿«èŠ‚ç‚¹ ==========
      - name: Select fastest node
        run: |
          # ç­‰å¾… Mihomo API å°±ç»ª
          sleep 20
          
          response=$(curl -s http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹)
          echo "æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯: $response"

          nodes=$(echo "$response" | jq -r '.all[] | @uri')
          echo "å¯ç”¨èŠ‚ç‚¹: $nodes"

          fastest_node=""
          min_delay=999999
          for node in $nodes; do
            if [ "$node" == "DIRECT" ]; then
              echo "è·³è¿‡ DIRECT èŠ‚ç‚¹"
              continue
            fi
            echo "æµ‹è¯•èŠ‚ç‚¹: $node"

            delay=$(curl -o /dev/null -s -w "%{time_total}\n" -x http://127.0.0.1:7890 -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" http://1.1.1.1 --connect-timeout 10 --max-time 10)
            if [ $? -ne 0 ]; then
              echo "èŠ‚ç‚¹ $node ä¸å¯ç”¨ï¼Œè·³è¿‡"
              continue
            fi
            echo "èŠ‚ç‚¹ $node çš„å»¶è¿Ÿ: $delay ç§’"

            if (( $(echo "$delay < $min_delay" | bc -l) ); then
              min_delay=$delay
              fastest_node=$node
            fi
          done

          echo "æœ€å¿«èŠ‚ç‚¹: $fastest_node, å»¶è¿Ÿ: $min_delay ç§’"
          curl -X PUT http://127.0.0.1:9090/proxies/ğŸ”°%20é€‰æ‹©èŠ‚ç‚¹ -d "{\"name\":\"$(echo -n $fastest_node | jq -sRr @uri)\"}"
          echo "å·²é€‰æ‹©æœ€å¿«èŠ‚ç‚¹: $fastest_node"

      # ========== éªŒè¯ä»£ç†é“¾ ==========
      - name: Test Proxy Chain
        run: |
          echo "æµ‹è¯• Mihomo ä»£ç†ï¼ˆ7890 ç«¯å£ï¼‰ï¼š"
          curl -x http://127.0.0.1:7890 -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" https://api.ip.sb/geoip

          echo "æµ‹è¯•åŒé‡ä»£ç†ï¼ˆMihomo -> WireGuardï¼‰ï¼š"
          curl -x http://127.0.0.1:7890 -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" https://api.ip.sb/geoip

      # ========== åç»­æ­¥éª¤ï¼ˆä¿æŒåŸæœ‰é…ç½®ï¼‰==========
      - name: Install VNC and Desktop
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            tightvncserver \
            novnc \
            firefox \
            xclip

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          echo -e "SendPrimary=1\nAcceptCutText=1" > ~/.vnc/config

          echo '#!/bin/bash
          source ~/.bash_profile
          export DISPLAY=:1
          vncconfig -nowin &
          #startxfce4 &' > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

      - name: Start VNC Server
        run: |
          vncserver :1 -geometry 1280x800 -depth 24 &
          sleep 5

      - name: Configure noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git &
          sleep 10
          cd noVNC
          ./utils/novnc_proxy --vnc localhost:5901 &
          sleep 5

      - name: Start Cloudflared
        run: |
          cloudflared tunnel --url tcp://localhost:5901 --protocol http2 &
          cloudflared tunnel --url http://localhost:9090 &
          cloudflared tunnel --url http://localhost:6080 &
          sleep 10

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date +'%F %T')] æœåŠ¡çŠ¶æ€ï¼š"
            echo "1. VNC è¿›ç¨‹: $(pgrep -a Xvnc || echo 'æœªè¿è¡Œ')"
            echo "2. å‰ªè´´æ¿å®ˆæŠ¤è¿›ç¨‹: $(pgrep -a vncconfig || echo 'æœªè¿è¡Œ')"
            echo "3. WireGuard çŠ¶æ€: $(sudo wg show)"
            echo "4. Mihomo è¿›ç¨‹: $(pgrep -a mihomo || echo 'æœªè¿è¡Œ')"
            sleep 300
          done
